DOCUMENTATION 4 (Version 3)
Shift-Wise Behavioral Modeling with Peer-Aware Anomaly Calibration
1. Project Overview (V3):
BehaviorGuard-AI Version 3 introduces a structural redesign of the anomaly detection pipeline established in Version 2. While V2 implemented a global shift-level Isolation Forest model, empirical analysis revealed significant instability caused by structural heterogeneity across users.
Version 3 transitions the system from a global density-based anomaly detector to a peer-aware, shift-aware, density-calibrated anomaly detection framework.
This phase focuses on:
1)	Reducing anomaly inflation
2)	Eliminating structural false positives
3)	Introducing peer-group modeling
4)	Stabilizing alert rates across shifts
5)	Maintaining a fully unsupervised architecture
Version 3 represents a methodological shift from “model tuning” to architectural correction.

2. Problem Identification
Analysis of Version 2 revealed multiple structural weaknesses:
2.1 High Anomaly Inflation
Observed anomaly rates ranged between 10–20%, significantly exceeding realistic insider threat expectations.
2.2 Structural Heterogeneity
Within each shift (Day, Evening, Night), user populations consisted of multiple behavioral archetypes:
1)	Low-activity stable users
2)	High-volume consistent users
3)	Device-diverse users
4)	Irregular activity users
A single Isolation Forest attempted to model these mixed densities, leading to unstable partitions.
2.3 Mixed Density Bias
When multiple behavioral distributions coexist:
1)	Isolation depth becomes inconsistent
2)	Normal sub-populations appear anomalous relative to others
2.4 Zero-Threshold Bias
Using:
contamination="auto"
Isolation Forest applies:
decision_function < 0 → anomaly
Clusters with slightly negative score means were unfairly labeled anomalous, causing severe cluster level bias.

3. Objective of Version 3
Version 3 was designed to:
1)	Improve anomaly specificity
2)	Reduce structural false positives
3)	Introduce peer-aware modeling
4)	Stabilize anomaly rates across shifts
5)	Preserve unsupervised learning
The core hypothesis:
Structural heterogeneity inflates anomaly detection when using global density models.

4. Dataset Context
1)	The dataset contains ~3.3 million authentication records from a CERT-based enterprise log corpus.
2)	Raw logon and logoff events were aggregated into hourly user-level behavioral summaries.
3)	Data was segmented into Day, Evening, and Night shifts (~1M records each).
4)	Each shift includes approximately 3,000–4,000 unique users.
5)	Features capture activity intensity, device diversity, and time-of-day patterns.
6)	Z-score features quantify deviation from individual user baselines.
7)	Hourly aggregation reduces noise and enables structured anomaly modeling.

5. Experimental Phases in Version 3
Phase 1: Daily Regime Modeling (Exploratory Attempt)
Approach:
Cluster (user, date) daily aggregates to capture workload regimes.
Observations:
1)	Day shift showed moderate improvement.
2)	Evening and Night exhibited renewed anomaly inflation.
3)	Regime clustering captured workload variability rather than structural behavior identity.
Conclusion:
Daily clustering was too granular and unstable for uniform deployment.
Decision: Architectural rollback.
This rollback demonstrates disciplined model governance.
Phase 2 : User-Level Behavioral Archetype Clustering (Final Architecture)

6. Step 1: User Baseline Profile Construction
For each shift:
One row per user was constructed.
Aggregated User Features:
1)	mean_logon_count
2)	std_logon_count
3)	total_logon_volume (log-transformed)
4)	mean_unique_pcs
5)	std_unique_pcs
6)	mean_activity_hour
7)	activity_hour_std
These features form behavioral identity vectors, representing structural user characteristics rather than hourly deviations.

7. Step 2 — Peer Group Clustering
Peer group clustering was performed to segment users based on structural behavioral characteristics. Prior to clustering, features were normalized using StandardScaler to ensure comparable scaling across dimensions. The KMeans algorithm was then applied with k = 4, which was empirically found to produce stable and well-separated clusters. In the Day shift, cluster distribution was approximately 37%, 23%, 22%, and 18%, indicating balanced group formation. The resulting clusters corresponded to distinct behavioral archetypes, including low activity stable users, moderate irregular users, device-diverse users, and high volume stable users. The clusters were balanced, interpretable, and non degenerate, confirming the presence of structural heterogeneity within the user population.

8. Step 3 — Merging Cluster Labels
After clustering users into behavioral peer groups, the assigned cluster IDs were merged back into the hourly level dataset. As a result, each hourly record now includes a behavioral peer group identifier corresponding to the structural archetype of the user. This design ensures a clear separation of concerns within the architecture: clustering performs structural segmentation of users based on long-term behavioral characteristics, while the Isolation Forest operates solely on hourly activity features to detect deviations. This separation prevents structural bias from influencing anomaly detection and maintains architectural clarity

9. Step 4 — Isolation Forest per Cluster
In this step, anomaly detection was performed separately within each peer cluster for every shift. For a given shift, hourly records were first filtered based on cluster membership, and an independent Isolation Forest model was trained for each cluster. This localized modeling approach allows the algorithm to learn density structures specific to each behavioral archetype rather than fitting a single global distribution.
The model was trained exclusively on hourly activity features—logon_count, logoff_count, unique_pcs, and hour—ensuring that only short-term behavioral deviations were evaluated. User-level baseline features used during clustering were intentionally excluded from the Isolation Forest input space to prevent structural leakage and preserve separation between segmentation and deviation modeling. Instead of relying on the binary predict() output, continuous decision_function scores were computed to retain anomaly score granularity and enable calibrated thresholding in later stages.

10. Discovery — Zero-Threshold Bias
Using:
contamination="auto"
Isolation Forest sets threshold at 0.
Observed:
1)	Some clusters had slightly negative mean scores.
2)	Entire clusters labeled anomalous.
3)	~500 users showed >50% anomaly rates.
Root Cause:
Decision boundary misaligned with score distribution.
Conclusion:
Binary prediction using zero threshold is unreliable.

11. Step 5 — Percentile-Based Threshold Calibration
Instead of:
model.predict()
Used:
threshold = cluster_scores.quantile(0.01)
alert if score < threshold
Each cluster independently calibrated at 1%.
This removes contamination dependency.

12. Results After Calibration
Day Shift
Alert rate ≈ 0.93%
Balanced across clusters
Evening Shift
Alert rate ≈ 0.997%
Cluster ratios ≈ 1%
Night Shift
Alert rate ≈ 0.958%
Stable across clusters

13. Major Findings
Finding 1 — Structural Heterogeneity Exists
Global models inflate anomalies due to mixed densities.
Finding 2 — Peer Segmentation Improves Density Modeling
User-level clustering reduces structural bias.
Finding 3 — Thresholding Is More Critical Than Contamination
Percentile calibration ensures:
1)	Controlled alert rate
2)	Fair distribution
3)	Cross-shift stability
Finding 4 — Daily Regime Modeling Is Over-Complex
User-level archetypes better align with UEBA design principles.
Finding 5 — Architecture Generalizes Across Shifts
After percentile correction:
1)	Day
2)	Evening
3)	Night
operate under identical modeling strategy.

14. Final Version 3 Architecture
For each shift:
1.	Build user behavioral profiles
2.	Cluster users into peer groups
3.	Merge cluster labels into hourly dataset
4.	Train Isolation Forest per cluster
5.	Compute anomaly scores
6.	Apply 1% percentile threshold per cluster
7.	Generate alerts

15. Conclusion
Version 3 represents a structural advancement in the BehaviorGuard-AI framework. By introducing peer aware clustering and percentile based anomaly calibration, the system eliminates structural anomaly inflation, reduces false positives, and stabilizes alert rates across shifts.
This phase moves the project from model experimentation to architectural maturity and establishes a stable foundation for contextual risk fusion and advanced threat scoring in future versions.

